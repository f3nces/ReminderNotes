# Malware Analysis

[TOC]

### Malware Analysis Techniques

+ **Static Analysis** - examining malware without running it
  + **Basic Static Analysis** -  consists of examining the executable file without viewing the actual instructions
  + **Advanced Static Analysis** -  consists of reverse-engineering the malware’s internals by loading the executable into a disassembler and looking at the program instructions in order to discover what the program does
+ **Dynamic Analysis** -  involves running the malware
  + **Basic Dynamic Analysis** -   involve running the malware and observing its behaviour on the system in order to remove the infection, produce effective signatures, or both
  + **Advanced Dynamic Analysis** -   uses a debugger to examine the internal state of a
running malicious executable



### Static Properties Analysis

#### 1. Antivirus Scanning/ Data Repositories Lookup
+ Useful to run several different antivirus programs against the same piece of suspected malware or  look up the file in malware data repositories
+ [VirustTotal](https://www.virustotal.com/gui/) 
+ [Hybrid Analysis](https://www.hybrid-analysis.com/)

#### 2. Calculate Hashes
+ MD5
+ SHA-1
+ SHA-256

#### 3. Find Strings
+ A program contains strings if it prints a message, connects to a URL, or copies a file to a specific location, etc...
+ ASCII and Unicode formats store characters in sequences that end with a NULL terminator (0x00) to indicate that the string is complete

#### 4. Packer Identification
+ Subset of obfuscated programs in which the malicious program is compressed and cannot be analysed
+ **Packer Indicators**:
  +  Lack of Readable Strings
  +  Few Dependencies (few Libraries)
  +   Often include at least the functions: ***LoadLibrary*** , ***GetProcAddress***, ***VirtualAlloc***,  ***LdrGetProcAddress*** or ***LdrLoadDll***
  +    .text section is larger in memory than on disk
+ Detecting Packers with **PEiD** (may run the malware executable without warning)

#### 5. Linked Libraries and Functions (Imports & Exports)
+ Linking Types:
  + Static Linking - all code from the library is copied into the executable
    +  difficult to differentiate between statically linked code and the executable’s own code, because
nothing in the PE file header indicates that the file contains linked code 
    
  + Running Linking -  connect to libraries only when that function is needed
    
    +  commonly used in packed or obfuscated malware
    
  + Dynamic Linking -  OS searches for the necessary libraries when the program is loaded
  
+ Because DLLs are specifically implemented to provide functionality used by EXEs, exported functions are most common in DLLs. EXEs are not designed to provide functionality for other EXEs, and exported functions are rare

#### 6. Look for Embedded Artifacts

#### 7. Portable Executable (PE) File Format

+ Used by Windows executables, object code, and DLLs
+ PE files begin with a header that includes information about the code, the type of application, required library functions (imports and exports), and space requirements
+ Common Sections:
  + **.text** - Contains the executable code
  + **.rdata** -  Contains the import and export information
  + **.data** -  Program’s global data, which is accessible from anywhere in the program
  + **.rsrc** - Stores resources needed by the executable
+ Examining PE Files Header with **PEview**
  + Compare Virtual Size (memory) and Size of Raw Data(disk) (should usually be equal)

+ Examine **Resource Section** with **Resource Hacker**
  + Look for embedded program or driver -  extract these files for individual analysis